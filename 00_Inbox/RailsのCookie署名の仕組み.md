---
date: 2026-01-17 17:55
tags:
  - TIL
  - Status/æ›¸ãã‹ã‘
  - Rails
  - Security
---

# Railsã®Cookieæ“ä½œã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç½²å
## ğŸ’¡ å­¦ã‚“ã ã“ã¨ãƒ»è§£æ±ºã—ãŸèª²é¡Œ
Railsã«ãŠã‘ã‚‹Cookieã®åŸºæœ¬çš„ãªèª­ã¿æ›¸ãæ–¹æ³•ã¨ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’é˜²ããŸã‚ã®ã€Œç½²åä»˜ãï¼ˆSignedï¼‰ã€ã‚„ã€Œæš—å·åŒ–ï¼ˆEncryptedï¼‰ã€Cookieã®ä½¿ã„åˆ†ã‘ã«ã¤ã„ã¦ã€‚
## ğŸ“ è©³ç´°ãƒ»åŸå› 
* **åŸºæœ¬:** Railsã®Cookieã¯`ActionController::Cookies`çµŒç”±ã§æ“ä½œã™ã‚‹ã€‚å€¤ã¯åŸºæœ¬çš„ã«Stringå‹ã€‚
* **ãƒªã‚¹ã‚¯:** é€šå¸¸ã®Cookieã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã§ä¸­èº«ã‚’è¦‹ãŸã‚Š**æ”¹ã–ã‚“**ã—ãŸã‚Šã§ãã‚‹ãŸã‚ã€èªè¨¼æƒ…å ±ãªã©ã‚’ãã®ã¾ã¾ä¿å­˜ã™ã‚‹ã®ã¯å±é™ºã€‚
* **å¯¾ç­–:** ç”¨é€”ã«å¿œã˜ã¦ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã„åˆ†ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ 
	* `signed`: ä¸­èº«ã¯è¦‹ãˆã‚‹ãŒã€æ”¹ã–ã‚“ã•ã‚Œã‚‹ã¨ç„¡åŠ¹ã«ãªã‚‹ï¼ˆæ”¹ã–ã‚“é˜²æ­¢ï¼‰ã€‚
	* `encrypted`: ä¸­èº«ã‚‚è¦‹ãˆãšã€æ”¹ã–ã‚“ã‚‚ã§ããªã„ï¼ˆæ©Ÿå¯†æƒ…å ±ç”¨ï¼‰ã€‚
## ğŸ’» è§£æ±ºç­–ãƒ»ã‚³ãƒ¼ãƒ‰
### 1. åŸºæœ¬çš„ãªæ›¸ãè¾¼ã¿ã¨èª­ã¿å‡ºã—  
```ruby
# æ›¸ãè¾¼ã¿ (åŸºæœ¬ã¯String)
cookies[:user_name] = "david"
# è¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿ã¯JSONã«ã™ã‚‹
cookies[:lat_lon] = JSON.generate([47.68, -122.37])
# èª­ã¿å‡ºã—
puts cookies[:user_name] # => "david"
```

### 2.ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆç½²åã¨æš—å·åŒ–ï¼‰
```ruby
# ã€ç½²åä»˜ãã€‘ æ”¹ã–ã‚“é˜²æ­¢ (ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãªã©)
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å€¤ã‚’è¦‹ã‚Œã‚‹ãŒã€å¤‰æ›´ã™ã‚‹ã¨ç„¡åŠ¹ã«ãªã‚‹
cookies.signed[:user_id] = current_user.id
# èª­ã¿å‡ºã—
cookies.signed[:user_id] 

# ã€æš—å·åŒ–ã€‘ å®Œå…¨éš è”½ (å‰²å¼•ã‚³ãƒ¼ãƒ‰ã€ä¸€æ™‚çš„ãªèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãªã©)
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å€¤ã‚’è¦‹ã‚‹ã“ã¨ã‚‚å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚ã§ããªã„
cookies.encrypted[:discount] = 45
# èª­ã¿å‡ºã—
cookies.encrypted[:discount]

# ã€æœŸé™ä»˜ããƒ»æ°¸ç¶šåŒ–ã€‘
cookies.permanent[:login] = "XJ-122" # 20å¹´æœ‰åŠ¹
cookies.signed.permanent[:login] = "XJ-122" # ãƒã‚§ãƒ¼ãƒ³ã‚‚å¯èƒ½
```
### 3. ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šã¨å‰Šé™¤
å‰Šé™¤æ™‚ã®æ³¨æ„ç‚¹ï¼šæ›¸ãè¾¼ã¿æ™‚ã« `:domain` ã‚’æŒ‡å®šã—ãŸå ´åˆã€**å‰Šé™¤æ™‚ã«ã‚‚åŒã˜ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŒ‡å®šã—ãªã„ã¨æ¶ˆãˆãªã„**ã€‚
```ruby
# ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»˜ãã§æ›¸ãè¾¼ã¿
cookies[:name] = {
  value: 'cookie value',
  expires: 1.hour,       # æœŸé™
  domain: 'domain.com',  # ãƒ‰ãƒ¡ã‚¤ãƒ³æŒ‡å®š
  secure: true,          # HTTPSã®ã¿
  httponly: true         # JavaScriptã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ (XSSå¯¾ç­–)
}

# å‰Šé™¤ (ãƒ‰ãƒ¡ã‚¤ãƒ³æŒ‡å®šãŒã‚ã‚‹å ´åˆã¯å¿…é ˆï¼)
cookies.delete(:name, domain: 'domain.com')
```
## ğŸ”— å‚è€ƒãƒªãƒ³ã‚¯
- https://api.rubyonrails.org/v7.2/classes/ActionDispatch/Cookies.html
## ğŸ’­ æ„Ÿæƒ³ãƒ»æ¬¡ã¸ã®èª²é¡Œ